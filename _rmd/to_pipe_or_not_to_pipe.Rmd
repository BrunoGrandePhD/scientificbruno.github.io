---
title: "When (Not) to Use Pipes in R"
author: "Bruno Grande"
date: "2016-09-21"
output: 
  md_document:
    preserve_yaml: true
    variant: markdown_github
layout: post
tags: [r]
read_more: false
---

```{r load_pkgs, echo=FALSE}
library(magrittr)
```


When I first learned about pipes in R, they seemed like an elegant solution for a common scenario: performing successive data transformations where only the final value is of interest. Traditionally, this is achieved by either reassigning a variable after each transformation or nesting function calls. Both approaches are demonstrated below for calculating the root mean square of 1000 random numbers. 

```{r without_pipes}
# Ensure reproducibility
set.seed(1)

# Generate a vector of 1000 random numbers
x <- rnorm(1000)

# Traditional approach #1: reassigning a variable
result <- x^2
result <- mean(result)
result <- sqrt(result)

# Traditional approach #2: nesting function calls
result <- sqrt(mean(x^2))
```


The first approach is readable but repeats the variable `result` five times instead of the ideal once. The second approach avoids repetition at the expense of readability. I realize `sqrt(mean(x^2))` is not _that_ unreadable, but it gets worse with more complex data transformations such as data frame manipulations. 

A variant of the first approach changes the variable name at each step. While this technically reduces repetition, you now have to keep track of multiple variable names and it's harder to add a new transformation in the middle. 

Now, compare the approaches above with the following alternative using pipes in R. Specifically, I'm using the pipes from the magrittr package. On the surface, it achieves readability without repetition. For those of you who are not familiar with pipes, the general idea is that the result of the left-hand side is passed as the first argument of the right-hand side. For more details on pipes, read the [relevant section](http://r4ds.had.co.nz/pipes.html) in R for Data Science by Hadley Wickam.

```{r with_pipes}
result <-
  x^2 %>%
  mean() %>%
  sqrt()
```


My familiarity with Unix pipes and usage of pipe-friendly packages (_e.g._ dplyr, tidyr and ggplot2)  accelerated my adoption of magrittr pipes. It quickly became second nature to chain function calls using pipes if I was only interested in the final value. I didn't realize there were any downsides. 

_dramatic pause..._

That is, until now!

----

https://renkun.me/blog/2014/08/08/difference-between-magrittr-and-pipeR.html

http://www.fromthebottomoftheheap.net/2015/06/03/my-aversion-to-pipes/

http://stackoverflow.com/questions/35933272/why-is-using-dplyr-pipe-slower-than-an-equivalent-non-pipe-expression/35935105

```{r}

library(pipeR)



func <- function(x) {
  as.list(sqrt(abs(x^2)))
}

func2 <- function(x) {
  purrr::map(x, ~.x^2 %>% abs() %>% sqrt())
}

func3 <- function(x) {
  purrr::map(x, ~.x^2) %>% 
    purrr:::map(abs) %>% 
    purrr::map(sqrt)
}

func4 <- function(x) {
  purrr::map(x, ~sqrt(abs(.x^2)))
}

testthat::expect_identical(func(x), func2(x))
testthat::expect_identical(func(x), func3(x))
testthat::expect_identical(func(x), func4(x))

microbenchmark::microbenchmark(func(x), func2(x), func3(x), func4(x), times = 10)
```

**Disclaimer:** I'm by no means an R expert, so I might have gotten something wrong. This post is as much about informing others as it is about collecting people's thoughts on the topic. 
